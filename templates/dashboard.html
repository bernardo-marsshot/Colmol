{% extends "base.html" %}

{% block page_head %}
  <!-- Chart.js só nesta página -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<h1 class="mb-3">Painel de Controlo</h1>

<div class="row g-3">
  <div class="col-md-3"><div class="card p-3"><div>Total de Documentos</div><h3>{{ total_docs }}</h3></div></div>
  <div class="col-md-3"><div class="card p-3"><div>Processado</div><h3>{{ matched }}</h3></div></div>
  <div class="col-md-3"><div class="card p-3"><div>Com Exceções</div><h3>{{ exceptions }}</h3></div></div>
  <div class="col-md-3"><div class="card p-3"><div>Fornecedores</div><h3>{{ suppliers }}</h3></div></div>
</div>

<div class="row mt-4">
  <div class="col-md-6">
    <div class="card p-3 h-100">
      <h5 class="mb-3">Processamento</h5>
      <canvas id="kpiChart" style="max-height: 300px;"></canvas>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3 h-100">
      <h5 class="mb-3">Leitura do Último Documento</h5>
      {% if latest_doc_stats.has_doc %}
        <canvas id="lineReadingChart" style="max-height: 300px; cursor: pointer;" onclick="showLineDetails()"></canvas>
        <p class="text-center text-muted mt-2 small mb-0">
          {{ latest_doc_stats.doc_type }} {{ latest_doc_stats.doc_number }} - {{ latest_doc_stats.supplier_name }}
        </p>
      {% else %}
        <div class="d-flex align-items-center justify-content-center" style="height: 300px;">
          <p class="text-muted mb-0">Sem documentos processados</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="card p-3 mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Últimos documentos</h5>
    <div class="d-flex gap-3 flex-wrap">
      <small class="d-flex align-items-center gap-1"><span class="badge bg-success">✓</span><span class="text-muted">Processado</span></small>
      <small class="d-flex align-items-center gap-1"><span class="badge bg-warning">!</span><span class="text-muted">Com exceções</span></small>
      <small class="d-flex align-items-center gap-1"><span class="badge bg-danger">✗</span><span class="text-muted">Erro</span></small>
      <small class="d-flex align-items-center gap-1"><span class="badge bg-secondary">-</span><span class="text-muted">Pendente</span></small>
    </div>
  </div>

  {% for d in latest %}
  <div class="mb-3">
    <div class="row align-items-center">
      <div class="col-md-2"><small class="text-muted">{{ d.received_at|date:"d/m H:i" }}</small></div>
      <div class="col-md-2"><span class="text-muted">{{ d.supplier.name }}</span></div>
      <div class="col-md-4">
        <a href="{% url 'inbound_detail' d.pk %}" class="btn-bizneo-document">
          <i class="bi bi-file-earmark-text"></i> {{ d.get_doc_type_display }} {{ d.number }}
        </a>
      </div>
      <div class="col-md-1">
        {% if d.po %}<small class="text-muted">{{ d.po.number }}</small>{% else %}<small class="text-muted">-</small>{% endif %}
      </div>
      <div class="col-md-3 d-flex align-items-center gap-2">
        {% if d.match_result %}
          {% if d.match_result.status == 'matched' %}
            <span class="badge bg-success">✓</span>
          {% elif d.match_result.status == 'exceptions' %}
            <span class="badge bg-warning">!</span>
          {% elif d.match_result.status == 'error' %}
            <span class="badge bg-danger">✗</span>
          {% else %}
            <span class="badge bg-secondary">-</span>
          {% endif %}
        {% else %}
          <span class="badge bg-secondary">-</span>
        {% endif %}

        <div class="d-flex align-items-center gap-1 flex-grow-1">
          <div class="progress" style="height: 6px; width: 80px; background-color: #e9ecef;">
            {% if d.reading_percentage == 100 %}
              <div class="progress-bar bg-success" role="progressbar" style="width: {{ d.reading_percentage }}%;"></div>
            {% elif d.reading_percentage >= 50 %}
              <div class="progress-bar bg-warning" role="progressbar" style="width: {{ d.reading_percentage }}%;"></div>
            {% elif d.reading_percentage > 0 %}
              <div class="progress-bar bg-danger" role="progressbar" style="width: {{ d.reading_percentage }}%;"></div>
            {% else %}
              <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%;"></div>
            {% endif %}
          </div>
          <small class="text-muted" style="min-width: 35px; font-size: 0.75rem;">{{ d.reading_percentage }}%</small>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="text-center py-4"><p class="text-muted mb-0">Sem documentos ainda.</p></div>
  {% endfor %}
</div>

<!-- Modal Detalhes de Leitura -->
<div class="modal fade" id="lineDetailsModal" tabindex="-1" aria-labelledby="lineDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #FF6B35; color: white;">
        <h5 class="modal-title" id="lineDetailsModalLabel">Detalhes de Leitura do Documento</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        {% if latest_doc_stats.has_doc %}
        <div class="mb-3">
          <h6 class="text-muted mb-2">Informação do Documento</h6>
          <div class="d-flex justify-content-between mb-1"><span><strong>Tipo:</strong></span><span>{{ latest_doc_stats.doc_type }}</span></div>
          <div class="d-flex justify-content-between mb-1"><span><strong>Número:</strong></span><span>{{ latest_doc_stats.doc_number }}</span></div>
          <div class="d-flex justify-content-between mb-1"><span><strong>Fornecedor:</strong></span><span>{{ latest_doc_stats.supplier_name }}</span></div>
        </div>
        <hr>
        <div class="mb-3">
          <h6 class="text-muted mb-2">Estatísticas de Leitura</h6>
          <div class="d-flex justify-content-between mb-1"><span><strong>Total de Linhas:</strong></span><span class="badge bg-secondary">{{ latest_doc_stats.total_lines }}</span></div>
          <div class="d-flex justify-content-between mb-1"><span><strong>Linhas Lidas com Sucesso:</strong></span><span class="badge bg-success">{{ latest_doc_stats.lines_read }}</span></div>
          <div class="d-flex justify-content-between mb-1"><span><strong>Linhas com Erro:</strong></span><span class="badge bg-danger">{{ latest_doc_stats.lines_error }}</span></div>
        </div>
        <hr>
        <div>
          <h6 class="text-muted mb-2">Posição no Documento</h6>
          {% if latest_doc_stats.last_line_read %}
          <div class="alert alert-success mb-2" role="alert">
            <i class="bi bi-check-circle"></i> Lido até linha: <strong>{{ latest_doc_stats.last_line_read }}</strong>
          </div>
          {% endif %}
          {% if latest_doc_stats.first_error_line %}
          <div class="alert alert-danger mb-0" role="alert">
            <i class="bi bi-x-circle"></i> Erro a partir da linha: <strong>{{ latest_doc_stats.first_error_line }}</strong>
          </div>
          {% elif latest_doc_stats.lines_error > 0 %}
          <div class="alert alert-warning mb-0" role="alert">
            <i class="bi bi-exclamation-triangle"></i> Documento com exceções (linha de erro não identificada)
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
(function(){
  // KPI doughnut
  const kpiCtx = document.getElementById('kpiChart');
  new Chart(kpiCtx, {
    type: 'doughnut',
    data: {
      labels: ['Processado', 'Com exceções', 'Erro', 'Pendente'],
      datasets: [{
        data: [{{ matched }}, {{ exceptions }}, {{ errors|default:0 }}, {{ pending|default:0 }}],
        backgroundColor: ['#198754','#ffc107','#dc3545','#6c757d'],
        borderColor: ['#198754','#ffc107','#dc3545','#6c757d'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#e8eaed', usePointStyle: true } },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const total = {{ total_docs|default:0 }};
              const val = ctx.parsed;
              const pct = total ? (val * 100 / total).toFixed(1) : 0;
              return ctx.label + ': ' + val + ' (' + pct + '%)';
            }
          }
        }
      }
    }
  });

  // Último documento (se existir)
  {% if latest_doc_stats.has_doc %}
  const lineCtx = document.getElementById('lineReadingChart');
  new Chart(lineCtx, {
    type: 'doughnut',
    data: {
      labels: ['Linhas Lidas', 'Linhas com Erro'],
      datasets: [{
        data: [{{ latest_doc_stats.lines_read }}, {{ latest_doc_stats.lines_error }}],
        backgroundColor: ['#198754','#dc3545'],
        borderColor: ['#198754','#dc3545'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#e8eaed', usePointStyle: true } } }
    }
  });
  {% endif %}
})();
function showLineDetails(){
  const modal = new bootstrap.Modal(document.getElementById('lineDetailsModal'));
  modal.show();
}
</script>
{% endblock %}
