
{% extends "base.html" %}
{% block content %}
<h2>{{ inbound.get_doc_type_display }} {{ inbound.number }} — {{ inbound.supplier.name }}</h2>
<p>Recebido: {{ inbound.received_at|date:"Y-m-d H:i" }} • PO: {% if inbound.po %}{{ inbound.po.number }}{% else %}-{% endif %}</p>

<div class="row g-3">
  <div class="col-md-7">
    {% if inbound.parsed_payload.qr_code %}
    <div class="card p-3 mb-3">
      <h5>Dados QR Code</h5>
      <div class="row">
        <div class="col-md-8">
          <p><strong>Dados:</strong> {{ inbound.parsed_payload.qr_code.data }}</p>
          <p><strong>Hash:</strong> <code>{{ inbound.parsed_payload.qr_code.hash }}</code></p>
          {% if inbound.parsed_payload.qr_code.validation_url %}
          <p><strong>Validação:</strong> <a href="{{ inbound.parsed_payload.qr_code.validation_url }}" target="_blank">Verificar autenticidade</a></p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
    
    {% if inbound.parsed_payload.document_number or inbound.parsed_payload.po_number %}
    <div class="card p-3 mb-3">
      <h5>Dados OCR Extraídos</h5>
      {% if inbound.parsed_payload.document_number %}<p><strong>Documento:</strong> {{ inbound.parsed_payload.document_number }}</p>{% endif %}
      {% if inbound.parsed_payload.po_number %}<p><strong>PO Referenciado:</strong> {{ inbound.parsed_payload.po_number }}</p>{% endif %}
      {% if inbound.parsed_payload.supplier_name %}<p><strong>Fornecedor (OCR):</strong> {{ inbound.parsed_payload.supplier_name }}</p>{% endif %}
      {% if inbound.parsed_payload.delivery_date %}<p><strong>Data Entrega:</strong> {{ inbound.parsed_payload.delivery_date }}</p>{% endif %}
      {% if inbound.parsed_payload.totals %}
      <p><strong>Totais:</strong> {{ inbound.parsed_payload.totals.total_lines }} linhas, {{ inbound.parsed_payload.totals.total_quantity }} unidades</p>
      {% endif %}
    </div>
    {% endif %}
    
    <div class="card p-3">
      <h5>Linhas extraídas</h5>
      <table class="table table-sm align-middle">
        <thead><tr><th>Código Fornecedor</th><th>Descrição</th><th>SKU Interno</th><th>Qtd</th></tr></thead>
        <tbody>
        {% for l in inbound.lines.all %}
          <tr>
            <td>{{ l.supplier_code }}</td>
            <td>{{ l.description|default:"—" }}</td>
            <td>{{ l.maybe_internal_sku|default:"—" }}</td>
            <td>{{ l.qty_received }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="col-md-5">
    <div class="card p-3">
      <h5>Resultado do Matching</h5>
      {% if result %}
        <p>Status: <strong>{{ result.status }}</strong></p>
        <p>Certificação: <code>{{ result.certified_id }}</code></p>
        <pre class="bg-dark p-2 rounded">{{ result.summary|json_script:"summary" }}</pre>
      {% else %}
        <p>Pendente</p>
      {% endif %}
    </div>
    <div class="card p-3 mt-3">
      <h5>Exceções</h5>
      <ul>
        {% for e in inbound.exceptions.all %}
          <li>{{ e.line_ref }} — {{ e.issue }}</li>
        {% empty %}
          <li>Sem exceções 🎉</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<div class="card p-3 mt-3">
  <h5>Ficheiro original & Exportação</h5>
  <div class="d-flex gap-2 mb-3">
    <a class="btn text-white" style="background-color: #FF6B35; border-color: #FF6B35;" href="{{ inbound.file.url }}" target="_blank">Abrir PDF/Imagem</a>
    <a class="btn btn-success" href="{% url 'export_excel' inbound.pk %}">📊 Exportar Excel</a>
  </div>
  
  {% if inbound.parsed_payload.numero_requisicao %}
  <div class="alert alert-info">
    <strong>💾 Dados processados:</strong> Requisição {{ inbound.parsed_payload.numero_requisicao }} com {{ inbound.parsed_payload.totals.total_lines }} linhas e {{ inbound.parsed_payload.totals.total_quantity }} unidades.
  </div>
  {% endif %}
</div>
{% endblock %}
