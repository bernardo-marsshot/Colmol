
{% extends "base.html" %}
{% block content %}
<h2>{{ inbound.get_doc_type_display }} {{ inbound.number }} ‚Äî {{ inbound.supplier.name }}</h2>
<p>Recebido: {{ inbound.received_at|date:"Y-m-d H:i" }} ‚Ä¢ PO: {% if inbound.po %}{{ inbound.po.number }}{% else %}-{% endif %}</p>

<div class="row g-3">
  <div class="col-md-7">
    {% if inbound.parsed_payload.qr_code %}
    <div class="card p-3 mb-3">
      <h5>Dados QR Code</h5>
      <div class="row">
        <div class="col-md-8">
          <p><strong>Dados:</strong> {{ inbound.parsed_payload.qr_code.data }}</p>
          <p><strong>Hash:</strong> <code>{{ inbound.parsed_payload.qr_code.hash }}</code></p>
          {% if inbound.parsed_payload.qr_code.validation_url %}
          <p><strong>Valida√ß√£o:</strong> <a href="{{ inbound.parsed_payload.qr_code.validation_url }}" target="_blank">Verificar autenticidade</a></p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
    
    {% if inbound.parsed_payload.document_number or inbound.parsed_payload.po_number %}
    <div class="card p-3 mb-3">
      <h5>Dados OCR Extra√≠dos</h5>
      {% if inbound.parsed_payload.document_number %}<p><strong>Documento:</strong> {{ inbound.parsed_payload.document_number }}</p>{% endif %}
      {% if inbound.parsed_payload.po_number %}<p><strong>PO Referenciado:</strong> {{ inbound.parsed_payload.po_number }}</p>{% endif %}
      {% if inbound.parsed_payload.supplier_name %}<p><strong>Fornecedor (OCR):</strong> {{ inbound.parsed_payload.supplier_name }}</p>{% endif %}
      {% if inbound.parsed_payload.delivery_date %}<p><strong>Data Entrega:</strong> {{ inbound.parsed_payload.delivery_date }}</p>{% endif %}
      {% if inbound.parsed_payload.totals %}
      <p><strong>Totais:</strong> {{ inbound.parsed_payload.totals.total_lines }} linhas, {{ inbound.parsed_payload.totals.total_quantity }} unidades</p>
      {% endif %}
    </div>
    {% endif %}
    
    <div class="card p-3">
      <h5>Linhas extra√≠das</h5>
      <table class="table table-sm align-middle">
        <thead><tr><th>C√≥digo Fornecedor</th><th>SKU</th><th>Descri√ß√£o</th><th>SKU Interno</th><th>Qtd</th></tr></thead>
        <tbody>
        {% for l in inbound.lines.all %}
          <tr>
            <td>{{ l.supplier_code }}</td>
            <td>{{ l.article_code|default:"‚Äî" }}</td>
            <td>{{ l.description|default:"‚Äî" }}</td>
            <td>{{ l.maybe_internal_sku|default:"‚Äî" }}</td>
            <td>{{ l.qty_received }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="col-md-5">
    <div class="card p-3 mb-3">
      <h5 class="mb-3">Leitura de Linhas</h5>
      <div class="d-flex justify-content-center">
        <canvas id="lineReadingChart" style="max-width: 250px; max-height: 250px;"></canvas>
      </div>
      <div class="mt-3 text-center">
        <small class="d-flex align-items-center justify-content-center gap-2 mb-1">
          <span class="badge bg-success">‚óè</span>
          <span class="text-muted">Linhas Lidas: {{ line_stats.lines_read }}</span>
        </small>
        <small class="d-flex align-items-center justify-content-center gap-2">
          <span class="badge bg-danger">‚óè</span>
          <span class="text-muted">Linhas com Erro: {{ line_stats.lines_error }}</span>
        </small>
      </div>
    </div>
    
    <div class="card p-3">
      <h5>Resultado do Matching</h5>
      {% if result %}
        <p>Status: <strong>{{ result.status }}</strong></p>
        <p>Certifica√ß√£o: <code>{{ result.certified_id }}</code></p>
        <pre class="bg-dark p-2 rounded">{{ result.summary|json_script:"summary" }}</pre>
      {% else %}
        <p>Pendente</p>
      {% endif %}
    </div>
    <div class="card p-3 mt-3">
      <h5>Exce√ß√µes</h5>
      <ul>
        {% for e in inbound.exceptions.all %}
          <li>{{ e.line_ref }} ‚Äî {{ e.issue }}</li>
        {% empty %}
          <li>Sem exce√ß√µes üéâ</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<div class="card p-3 mt-3">
  <h5>Ficheiro original & Exporta√ß√£o</h5>
  <div class="d-flex gap-3 mb-3 flex-wrap">
    <a class="btn-bizneo-primary" href="{{ inbound.file.url }}" target="_blank">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Abrir PDF/Imagem
    </a>
    <a class="btn-bizneo-success" href="{% url 'export_excel' inbound.pk %}">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="12" y1="18" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="9,15 12,18 15,15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Exportar Excel
    </a>
  </div>
  
  {% if inbound.parsed_payload.numero_requisicao %}
  <div class="alert alert-info">
    <strong>üíæ Dados processados:</strong> Requisi√ß√£o {{ inbound.parsed_payload.numero_requisicao }} com {{ inbound.parsed_payload.totals.total_lines }} linhas e {{ inbound.parsed_payload.totals.total_quantity }} unidades.
  </div>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Line Reading Chart
const lineCtx = document.getElementById('lineReadingChart');
new Chart(lineCtx, {
  type: 'doughnut',
  data: {
    labels: ['Linhas Lidas', 'Linhas com Erro'],
    datasets: [{
      data: [{{ line_stats.lines_read }}, {{ line_stats.lines_error }}],
      backgroundColor: [
        '#198754',  // Verde para linhas lidas
        '#dc3545'   // Vermelho para linhas com erro
      ],
      borderColor: [
        '#198754',
        '#dc3545'
      ],
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        display: false
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            const total = {{ line_stats.total_lines }};
            const val = context.parsed;
            const pct = total ? (val * 100 / total).toFixed(1) : 0;
            return context.label + ': ' + val + ' (' + pct + '%)';
          }
        }
      }
    },
    elements: { 
      arc: { borderWidth: 3 } 
    }
  }
});
</script>
{% endblock %}
